name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18, 20]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.bun/install/cache
        key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
        restore-keys: |
          ${{ runner.os }}-bun-

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Type checking
      run: bun run typecheck

    - name: Linting
      run: bun run lint

    - name: Unit tests
      run: bun test

    - name: Preset validation
      run: bun run src/presets/__tests__/runner.ts

    - name: Build CLI
      run: bun run build

    - name: Test CLI functionality
      run: |
        # Test CLI help
        node dist/index.js --help

        # Test environment check
        node dist/index.js check-env

        # Test minimal project creation
        node dist/index.js create test-minimal --preset minimal --no-git --no-install

        # Verify project was created
        test -d test-minimal
        test -f test-minimal/package.json

        # Cleanup
        rm -rf test-minimal

  e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.bun/install/cache
        key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
        restore-keys: |
          ${{ runner.os }}-bun-

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Build CLI
      run: bun run build

    - name: Install browsers
      run: bunx playwright install --with-deps

    - name: Run E2E tests
      run: bun run test:e2e:quick
      env:
        CI: true

  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Audit dependencies
      run: bun audit

    - name: Check for vulnerabilities
      run: bunx audit-ci --config .audit-ci.json || true

  validate-presets:
    name: Validate All Presets
    runs-on: ubuntu-latest

    strategy:
      matrix:
        preset: [saas, ecommerce, blog, devtool, portfolio, minimal]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Build CLI
      run: bun run build

    - name: Test preset ${{ matrix.preset }}
      run: |
        # Create test project with preset
        node dist/index.js create test-${{ matrix.preset }} --preset ${{ matrix.preset }} --no-git --no-install

        # Verify essential files exist
        test -f test-${{ matrix.preset }}/package.json
        test -f test-${{ matrix.preset }}/README.md
        test -f test-${{ matrix.preset }}/CLAUDE.md
        test -d test-${{ matrix.preset }}/src

        # Verify package.json is valid JSON
        node -e "JSON.parse(require('fs').readFileSync('test-${{ matrix.preset }}/package.json', 'utf8'))"

        # Check if TypeScript config exists (for non-minimal presets)
        if [ "${{ matrix.preset }}" != "minimal" ]; then
          test -f test-${{ matrix.preset }}/tsconfig.json
        fi

        # Cleanup
        rm -rf test-${{ matrix.preset }}

  docs:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check required docs
      run: |
        # Verify required documentation files exist
        test -f README.md
        test -f CONTRIBUTING.md
        test -f CLAUDE.md
        test -f constitution.md
        test -f docs/API.md
        test -f docs/TROUBLESHOOTING.md
        test -f docs/PBS_MASTER_SYSTEM.md
        test -f docs/FORK_PLAN.md
        test -f docs/ARCHITECTURE.md
        test -f docs/PROJECT_STATUS.md
        test -f docs/CHANGELOG.md

        echo "✅ All required documentation files found"

    - name: Validate markdown
      uses: DavidAnson/markdownlint-action@v9
      with:
        files: '**/*.md'
        config: '.markdownlint.json'
        ignore: 'node_modules'
        fix: false

  publish-check:
    name: Publish Check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Build for publish
      run: bun run build

    - name: Validate package
      run: |
        # Check package.json fields
        node -e "
          const pkg = require('./package.json');
          if (!pkg.name) throw new Error('Missing package name');
          if (!pkg.version) throw new Error('Missing package version');
          if (!pkg.description) throw new Error('Missing package description');
          if (!pkg.main) throw new Error('Missing main entry point');
          if (!pkg.bin) throw new Error('Missing bin entry point');
          if (!pkg.keywords || pkg.keywords.length === 0) throw new Error('Missing keywords');
          console.log('✅ Package.json validation passed');
        "

    - name: Check build output
      run: |
        # Verify build artifacts
        test -f dist/index.js
        test -s dist/index.js  # File is not empty

        # Test built CLI
        node dist/index.js --version
        node dist/index.js --help

        echo "✅ Build output validation passed"

    - name: Dry run publish
      run: npm publish --dry-run